#!/bin/bash
#SBATCH --mail-user=tyler.j.hansen@vanderbilt.edu
#SBATCH --mail-type=ALL
#SBATCH --nodes=1                                                                                                
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --time=24:00:00
#SBATCH --mem=32G
#######################################################                                                                                                                 
# Tyler Hansen - 2021-02-04
# This is a script to conduct footprinting on "ATAC-seq" datasets using the TOBIAS package. 

#merge deduplicated DNA files before footprinting:
module restore tools
DIR='/data/hodges_lab/ATAC-STARR_V2/data/bams/pos-sorted'
samtools merge -@8 ${DIR}/GM12878inGM12878_DNA_merged.unique.pos-sorted.bam \
    ${DIR}/GM12878inGM12878_DNA_Rep1.unique.pos-sorted.bam ${DIR}/GM12878inGM12878_DNA_Rep1.unique.pos-sorted.bam

samtools merge -@8 ${DIR}/LCL8664inLCL8664_DNA_merged.unique.pos-sorted.bam \
    ${DIR}/LCL8664inLCL8664_DNA_Rep1.unique.pos-sorted.bam ${DIR}/LCL8664inLCL8664_DNA_Rep1.unique.pos-sorted.bam

samtools index -@8 ${DIR}/GM12878inGM12878_DNA_merged.unique.pos-sorted.bam ${DIR}/GM12878inGM12878_DNA_merged.unique.pos-sorted.bam.bai
samtools index -@8 ${DIR}/LCL8664inLCL8664_DNA_merged.unique.pos-sorted.bam ${DIR}/LCL8664inLCL8664_DNA_merged.unique.pos-sorted.bam.bai

#Now we can footprint!
module restore anaconda
source activate tobias

hg38='/data/hodges_lab/hg38_genome/hg38.fa'
rheMac10='/data/hodges_lab/rheMac10_genome/rheMac10.fa'
MOTIF='/home/hansetj1/JASPAR2020_CORE_vertebrates_non-redundant_pfms_jaspar.txt'

#GM12878 Buenrostro ATAC-seq. Only need the cut counts file for buenrostro. 
DIR='/data/hodges_lab/public_data/GM12878/obtained_as_raw_files/ATAC_GM12878_2013-buenrostro/data'
TOBIAS ATACorrect --bam ${DIR}/bams/pos-sorted/GM12878_ATAC-seq_buenrostro_merged.unique.pos-sorted.bam --genome $hg38 \
    --peaks ${DIR}/genrich_peaks/GM12878_ATAC-seq_buenrostro_genrich_0.0001-qvalue.narrowPeak \
   --blacklist /home/hansetj1/hg38_encode_blacklist_ENCFF356LFX.bed --outdir ${DIR}/footprinting/ATACorrect \
    --cores 8 --prefix GM12878_ATAC-seq_buenrostro

#GM12878 ATAC-STARR Accesssiblity Peaks
DIR='/data/hodges_lab/ATAC-STARR_V2/data'
TOBIAS ATACorrect --bam ${DIR}/bams/pos-sorted/GM12878inGM12878_DNA_merged.unique.pos-sorted.bam --genome $hg38 \
    --peaks ${DIR}/accessibility/genrich_ATAC-like_peaks/GM12878inGM12878_DNA_genrich_0.0001-qvalue.narrowPeak \
    --blacklist /home/hansetj1/hg38_encode_blacklist_ENCFF356LFX.bed --outdir ${DIR}/accessibility/footprinting/ATACorrect \
    --cores 8 --prefix GM12878inGM12878_DNA

TOBIAS ScoreBigwig --signal ${DIR}/accessibilty/footprinting/ATACorrect/GM12878inGM12878_DNA_corrected.bw \
    --regions ${DIR}/accessibility/genrich_ATAC-like_peaks/GM12878inGM12878_DNA_genrich_0.0001-qvalue.narrowPeak \
    --output ${DIR}/accessibility/footprinting/ScoreBigwig/GM12878inGM12878_DNA_footprints.bw --cores 8

TOBIAS BINDetect --bound-pvalue 0.05 --motifs $MOTIF --signals ${DIR}/accessibility/footprinting/ScoreBigwig/GM12878inGM12878_DNA_footprints.bw \
    --genome $hg38 --peaks ${DIR}/accessibility/genrich_ATAC-like_peaks/GM12878inGM12878_DNA_genrich_0.0001-qvalue.narrowPeak \
    --outdir ${DIR}/accessibility/footprinting/BINDetect/GM12878inGM12878_0.05 --cond_names GM12878inGM12878_DNA --cores 8