---
title: "Plotting Motif Enrichment Results from HOMER - ATAC-STARR"
author: "Tyler Hansen"
date: "January 13th, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Software, message=FALSE, warning=FALSE}
library(tidyverse)
library(data.table)
```

```{r, Functions}
#Tim's function
motifDotplot <- function(listOfTables, show, qThreshold, title){
  # Create a main database table with IDs and percent fold change column
  mainReferenceDBtemp <- rbindlist(listOfTables, idcol="ID")
  # Change to factor to maintain order in plotting
  mainReferenceDBtemp$ID <- factor(mainReferenceDBtemp$ID, levels = unique(mainReferenceDBtemp$ID))
  # convert percentages and calculate fold change
  mainReferenceDB <- mainReferenceDBtemp %>%
    mutate(percentTargetNum = (as.numeric(gsub("%", "", percentTarget, fixed = TRUE))/100)) %>%
    mutate(percentBackgroundNum = (as.numeric(gsub("%", "", percentBackground, fixed = TRUE))/100)) %>%
    mutate(percentFold = (percentTargetNum/percentBackgroundNum))
  # Convert the TF names to somthing more manageable
  mainReferenceDB <- mainReferenceDB %>%
    mutate(Motif = gsub("\\(.*", "", MotifName))
  # ^ Now have: master table with IDs and needed values
  
  # Next: Find out which rows to pull for graphing: 
  # Take first X amount of lines from tables
  loShortTables <- lapply(listOfTables, '[', c(1:show),)
  # Find the list of Motifs to extract
  shortTableDF <- rbindlist(loShortTables)
  voMotifsToExtract <- unique(shortTableDF$Consensus)
  # Use the main database table to pulloutrows
  tableToPlotAll <- mainReferenceDB[mainReferenceDB$Consensus %in% voMotifsToExtract,]
  tableToPlot <- tableToPlotAll[tableToPlotAll$q <= qThreshold,]
  # This command reorders Y-axis motifs nicely
  tableToPlot$Motif <- factor(tableToPlot$Motif,levels=rev(unique(tableToPlot$Motif)))
  # Find the maximum P value to scale the color with
  maxPValue <- max(abs(as.numeric(tableToPlot$logp)))
  medianPValue <- median(abs(as.numeric(tableToPlot$logp)))
  minPValue <- min(abs(as.numeric(tableToPlot$logp)))
  tableToPlot$max <- maxPValue
  tableToPlot$median <- medianPValue
  ttp<<-tableToPlot
  # Plot with GGPlot
  dotplotMotifs <- ggplot(tableToPlot, aes(x=ID, y=Motif)) + 
    geom_point(aes(size = percentFold, color = abs(as.numeric(logp)))) + 
    scale_colour_gradient(limits=c(minPValue, maxPValue), low="blue", high="red") +
    ggtitle(title) +
    labs(color = "|log10(p-val)|", size = "Percent Fold Change:\n(% target / % background)") +
    theme_bw(base_size = 14)
  dotplotMotifs
}
```

```{r, GM12878inLCL8664 Active: Compare Backgrounds}
#Read in motif results txt files
setwd("C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/results/Motif_Analysis")

GL_1 <- read_tsv("GM12878inLCL8664_active-REs_0.1padj_noBG/knownResults.txt", col_names=c("MotifName","Consensus","p","logp","q","numTarget", "percentTarget","numBackground","percentBackground"))

GL_2 <- read_tsv("GM12878inLCL8664_active-REs_0.1padj_GenrichBG/knownResults.txt", col_names=c("MotifName","Consensus","p","logp","q","numTarget", "percentTarget","numBackground","percentBackground"))

GL_3 <- read_tsv("GM12878inLCL8664_active-REs_0.1padj_FGs-flat-BG/knownResults.txt", col_names=c("MotifName","Consensus","p","logp","q","numTarget", "percentTarget","numBackground","percentBackground"))

# User needs to make a list of their output motif tables here:
comp_GL_list <- list(`Default` = GL_1, `Genrich ATAC Peaks` = GL_2, `Flattened Fragment Groups` = GL_3)

motifDotplot(listOfTables = comp_GL_list, show = 20, qThreshold=0.05, title="GMinLCL Motif Enrichment - Background Comparison")

```

```{r, GM12878inGM12878 Active: Compare Active and Silent}
#Read in motif results txt files
setwd("C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/results/Motif_Analysis")

GG_active <- read_tsv("GM12878inGM12878_active-REs_0.1padj_noBG/knownResults.txt", col_names=c("MotifName","Consensus","p","logp","q","numTarget", "percentTarget","numBackground","percentBackground"))

GG_silent <- read_tsv("GM12878inGM12878_silent-REs_0.1padj_noBG/knownResults.txt", col_names=c("MotifName","Consensus","p","logp","q","numTarget", "percentTarget","numBackground","percentBackground"))

# User needs to make a list of their output motif tables here:
GG_list <- list(`Active` = GG_active, `Silent` = GG_silent)

motifDotplot(listOfTables = GG_list, show = 20, qThreshold=0.05, title="GMinGM Motif Enrichment - Compare Active & Silent")

```

```{r, Compare GM12878inGM12878 and GM12878inLCL8664 }
#Read in motif results txt files
setwd("C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/results/Motif_Analysis")

GG_active <- read_tsv("GM12878inGM12878_active-REs_0.1padj_noBG/knownResults.txt", col_names=c("MotifName","Consensus","p","logp","q","numTarget", "percentTarget","numBackground","percentBackground"))

GL_active <- read_tsv("GM12878inLCL8664_active-REs_0.1padj_noBG/knownResults.txt", col_names=c("MotifName","Consensus","p","logp","q","numTarget", "percentTarget","numBackground","percentBackground"))

# User needs to make a list of their output motif tables here:
G_list <- list(`GMinGM` = GG_active, `GMinLCL` = GL_active)

motifDotplot(listOfTables = G_list, show = 20, qThreshold=0.05, title="Motif Enrichment - Compare GMinGM & GMinGL")

```

```{r, Compare all}
#Read in motif results txt files
setwd("C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/results/Motif_Analysis")

GG_active <- read_tsv("GM12878inGM12878_active-REs_0.1padj_noBG/knownResults.txt", col_names=c("MotifName","Consensus","p","logp","q","numTarget", "percentTarget","numBackground","percentBackground"))

GL_active <- read_tsv("GM12878inLCL8664_active-REs_0.1padj_noBG/knownResults.txt", col_names=c("MotifName","Consensus","p","logp","q","numTarget", "percentTarget","numBackground","percentBackground"))

LG_active <- read_tsv("LCL8664inGM12878_active-REs_0.1padj_hg38-from-rheMac10_noBG/knownResults.txt", col_names=c("MotifName","Consensus","p","logp","q","numTarget", "percentTarget","numBackground","percentBackground"))
  
LL_active <- read_tsv("LCL8664inLCL8664_active-REs_0.1padj_hg38-from-rheMac10_noBG/knownResults.txt", col_names=c("MotifName","Consensus","p","logp","q","numTarget", "percentTarget","numBackground","percentBackground"))

# User needs to make a list of their output motif tables here:
all_list <- list(`GMinGM` = GG_active, `GMinLCL` = GL_active, `LCLinGM` = LG_active, `LCLinLCL` = LL_active)

motifDotplot(listOfTables = all_list, show = 20, qThreshold=0.05, title="Motif Enrichment - Compare All Samples")

```