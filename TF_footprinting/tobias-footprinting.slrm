#!/bin/bash
#SBATCH --mail-user=tyler.j.hansen@vanderbilt.edu
#SBATCH --mail-type=ALL
#SBATCH --nodes=1                                                                                                
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --time=24:00:00
#SBATCH --mem=32G
#######################################################                                                                                                                 
# Tyler Hansen - 2021-02-04
# This is a script to conduct footprinting on three "ATAC-seq" datasets using the TOBIAS package. 

#merge DNA files before footprinting:
#module restore tools
#DIR='/data/hodges_lab/ATAC-STARR_V2/data/bams/pos-sorted'
#samtools merge -@8 ${DIR}/GM12878inGM12878_DNA_merged.unique.pos-sorted.bam \
#    ${DIR}/GM12878inGM12878_DNA_Rep1.unique.pos-sorted.bam ${DIR}/GM12878inGM12878_DNA_Rep1.unique.pos-sorted.bam

#samtools merge -@8 ${DIR}/LCL8664inLCL8664_DNA_merged.unique.pos-sorted.bam \
#    ${DIR}/LCL8664inLCL8664_DNA_Rep1.unique.pos-sorted.bam ${DIR}/LCL8664inLCL8664_DNA_Rep1.unique.pos-sorted.bam

#samtools index -@8 ${DIR}/GM12878inGM12878_DNA_merged.unique.pos-sorted.bam ${DIR}/GM12878inGM12878_DNA_merged.unique.pos-sorted.bam.bai
#samtools index -@8 ${DIR}/LCL8664inLCL8664_DNA_merged.unique.pos-sorted.bam ${DIR}/LCL8664inLCL8664_DNA_merged.unique.pos-sorted.bam.bai

#Now we can footprint!
#module restore anaconda
#source activate tobias

hg38='/data/hodges_lab/hg38_genome/hg38.fa'
rheMac10='/data/hodges_lab/rheMac10_genome/rheMac10.fa'
MOTIF='/home/hansetj1/JASPAR2020_CORE_vertebrates_non-redundant_pfms_jaspar.txt'

#GM12878 Buenrostro ATAC-seq
#DIR='/data/hodges_lab/public_data/GM12878/obtained_as_raw_files/ATAC_GM12878_2013-buenrostro/data'
#TOBIAS ATACorrect --bam ${DIR}/bams/pos-sorted/GM12878_ATAC-seq_buenrostro_merged.unique.pos-sorted.bam --genome $hg38 \
#    --peaks ${DIR}/genrich_peaks/GM12878_ATAC-seq_buenrostro_genrich_0.005-qvalue.narrowPeak \
#   --blacklist /home/hansetj1/hg38_encode_blacklist_ENCFF356LFX.bed --outdir ${DIR}/footprinting/ATACorrect \
#    --cores 8 --prefix GM12878_ATAC-seq_buenrostro

#TOBIAS ScoreBigwig --signal ${DIR}/footprinting/ATACorrect/GM12878_ATAC-seq_buenrostro_corrected.bw \
#    --regions ${DIR}/genrich_peaks/GM12878_ATAC-seq_buenrostro_genrich_0.005-qvalue.narrowPeak \
#    --output ${DIR}/footprinting/ScoreBigwig/GM12878_ATAC-seq_buenrostro_footprints.bw --cores 8

#TOBIAS BINDetect --motifs $MOTIF --signals ${DIR}/footprinting/ScoreBigwig/GM12878_ATAC-seq_buenrostro_footprints.bw \
#    --genome $hg38 --peaks ${DIR}/genrich_peaks/GM12878_ATAC-seq_buenrostro_genrich_0.005-qvalue.narrowPeak \
#    --outdir ${DIR}/footprinting/BINDetect --cond_names GM12878_ATAC-seq_buenrostro --cores 8

#GM12878 ATAC-STARR Accesssiblity Peaks
DIR='/data/hodges_lab/ATAC-STARR_V2/data'
#TOBIAS ATACorrect --bam ${DIR}/bams/pos-sorted/GM12878inGM12878_DNA_merged.unique.pos-sorted.bam --genome $hg38 \
#    --peaks ${DIR}/genrich_ATAC-like_peaks/GM12878inGM12878_DNA_genrich_0.005-qvalue.narrowPeak \
#    --blacklist /home/hansetj1/hg38_encode_blacklist_ENCFF356LFX.bed --outdir ${DIR}/footprinting/ATACorrect \
#    --cores 8 --prefix GM12878inGM12878_DNA

#TOBIAS ScoreBigwig --signal ${DIR}/footprinting/ATACorrect/GM12878inGM12878_DNA_corrected.bw \
#    --regions ${DIR}/genrich_ATAC-like_peaks/GM12878inGM12878_DNA_genrich_0.005-qvalue.narrowPeak \
#    --output ${DIR}/footprinting/ScoreBigwig/GM12878inGM12878_DNA_footprints.bw --cores 8

#TOBIAS BINDetect --motifs $MOTIF --signals ${DIR}/footprinting/ScoreBigwig/GM12878inGM12878_DNA_footprints.bw \
#    --genome $hg38 --peaks ${DIR}/genrich_ATAC-like_peaks/GM12878inGM12878_DNA_genrich_0.005-qvalue.narrowPeak \
#    --outdir ${DIR}/footprinting/BINDetect/GM12878inGM12878 --cond_names GM12878inGM12878_DNA --cores 8

#LCL8664 ATAC-STARR Accesssiblity Peaks
DIR='/data/hodges_lab/ATAC-STARR_V2/data'
#TOBIAS ATACorrect --bam ${DIR}/bams/pos-sorted/LCL8664inLCL8664_DNA_merged.unique.pos-sorted.bam --genome $rheMac10 \
#    --peaks ${DIR}/genrich_ATAC-like_peaks/LCL8664inLCL8664_DNA_genrich_0.005-qvalue.narrowPeak \
#    --outdir ${DIR}/footprinting/ATACorrect -cores 4 --prefix LCL8664inLCL8664_DNA

#TOBIAS ScoreBigwig --signal ${DIR}/footprinting/ATACorrect/LCL8664inLCL8664_DNA_corrected.bw \
#    --regions ${DIR}/genrich_ATAC-like_peaks/LCL8664inLCL8664_DNA_genrich_0.005-qvalue.narrowPeak \
#    --output ${DIR}/footprinting/ScoreBigwig/LCL8664inLCL8664_DNA_footprints.bw --cores 4

#TOBIAS BINDetect --motifs $MOTIF --signals ${DIR}/footprinting/ScoreBigwig/LCL8664inLCL8664_DNA_footprints.bw \
#    --genome $rheMac10 --peaks ${DIR}/genrich_ATAC-like_peaks/LCL8664inLCL8664_DNA_genrich_0.005-qvalue.narrowPeak \
#    --outdir ${DIR}/footprinting/BINDetect/LCL8664inLCL8664 --cond_names LCL8664inLCL8664_DNA --cores 4

#### Differential Footprinting: GM vs LCL ####
#Need to work in the same genome, so I'll liftover my rheMac10 bam using crossmap. I'll also lift over my hg38 bam 
module restore anaconda
source activate CrossMap_3

#Usage: CrossMap.py bam chain_file input_file output_file [options] 
# -m is the average insert size and -s is the standard deviation, which I obtain from picard's "CollectInsertSizeMetrics". 
# -t is "INSERT_SIZE_FOLD" and means this: "proper pairs" are if the distance between both ends is less then '-t' * stdev from the mean.
# Setting -t to 5 gives a 0-527bp window. 
DIR='/data/hodges_lab/ATAC-STARR_V2/data'
#CrossMap.py bam /data/hodges_lab/bin/map.chain/rheMac10ToHg38.over.chain.gz \
#    ${DIR}/bams/pos-sorted/LCL8664inLCL8664_DNA_merged.unique.pos-sorted.bam \
#    ${DIR}/bams/pos-sorted/LCL8664inLCL8664_DNA_merged.unique.pos-sorted_hg38-from-rheMac10.bam \
#    -m 177 -s 87.5 -t 4

CrossMap.py bam /data/hodges_lab/bin/map.chain/hg38ToRheMac10.over.chain.gz \
    ${DIR}/bams/pos-sorted/GM12878inGM12878_DNA_merged.unique.pos-sorted.bam \
    ${DIR}/bams/pos-sorted/GM12878inGM12878_DNA_merged.unique.pos-sorted_rheMac10-from-hg38.bam \
    -m 155 -s 76 -t 5

module restore anaconda
source activate tobias

#Make a new footprint bigwig file for the hg38 version of LCL. 
#TOBIAS ATACorrect --bam ${DIR}/bams/pos-sorted/LCL8664inLCL8664_DNA_merged.unique.pos-sorted_hg38-from-rheMac10.bam.sorted.bam --genome $hg38 \
#    --peaks ${DIR}/genrich_ATAC-like_peaks/LCL8664inLCL8664_DNA_genrich_hg38-from-rheMac10_0.005-qvalue.narrowPeak \
#    --blacklist /home/hansetj1/hg38_encode_blacklist_ENCFF356LFX.bed --outdir ${DIR}/footprinting/ATACorrect \
#    --cores 4 --prefix LCL8664inLCL8664_DNA_hg38

#TOBIAS ScoreBigwig --signal ${DIR}/footprinting/ATACorrect/LCL8664inLCL8664_DNA_hg38_corrected.bw \
#    --regions ${DIR}/genrich_ATAC-like_peaks/LCL8664inLCL8664_DNA_genrich_hg38-from-rheMac10_0.005-qvalue.narrowPeak \
#    --output ${DIR}/footprinting/ScoreBigwig/LCL8664inLCL8664_DNA_hg38_footprints.bw --cores 8

#Compare GM and LCL using BINDetect. Use the merged peaks file: GG+LL_genrich_0.005-qvalue_cat-then-merge.narrowPeak as the peaks option. 
#TOBIAS BINDetect --motifs $MOTIF --signals ${DIR}/footprinting/ScoreBigwig/GM12878inGM12878_DNA_footprints.bw \
#    ${DIR}/footprinting/ScoreBigwig/LCL8664inLCL8664_DNA_hg38_footprints.bw \
#    --genome $hg38 --peaks ${DIR}/genrich_ATAC-like_peaks/GG+LL_genrich_0.005-qvalue_cat-then-merge.narrowPeak \
#    --outdir ${DIR}/footprinting/BINDetect/Compare_GM-LCL --cond_names GM12878inGM12878 LCL8664inLCL8664_DNA --cores 8

#Make a new footprint bigwig file for the rheMac10 version of GM. 
TOBIAS ATACorrect --bam ${DIR}/bams/pos-sorted/GM12878inGM12878_DNA_merged.unique.pos-sorted_rheMac10-from-hg38.bam.sorted.bam --genome $rheMac10 \
    --peaks ${DIR}/genrich_ATAC-like_peaks/GM12878inGM12878_DNA_genrich_rheMac10-from-hg38_0.005-qvalue.narrowPeak \
    --outdir ${DIR}/footprinting/ATACorrect --cores 8 --prefix GM12878inGM12878_DNA_rheMac10

TOBIAS ScoreBigwig --signal ${DIR}/footprinting/ATACorrect/GM12878inGM12878_DNA_rheMac10_corrected.bw \
    --regions ${DIR}/genrich_ATAC-like_peaks/GM12878inGM12878_DNA_genrich_rheMac10-from-hg38_0.005-qvalue.narrowPeak \
    --output ${DIR}/footprinting/ScoreBigwig/GM12878inGM12878_DNA_rheMac10_footprints.bw --cores 8

#Compare GM and LCL using BINDetect. Use the merged peaks file: GG+LL_genrich_0.005-qvalue_cat-then-merge.narrowPeak as the peaks option. 
TOBIAS BINDetect --motifs $MOTIF --signals ${DIR}/footprinting/ScoreBigwig/GM12878inGM12878_DNA_rheMac10_footprints.bw \
    ${DIR}/footprinting/ScoreBigwig/LCL8664inLCL8664_DNA_footprints.bw \
    --genome $rheMac10 --peaks ${DIR}/genrich_ATAC-like_peaks/GG+LL_genrich_0.005-qvalue_cat-then-merge_rheMac10.narrowPeak \
    --outdir ${DIR}/footprinting/BINDetect/Compare_GM-LCL_rheMac10 --cond_names GM12878inGM12878 LCL8664inLCL8664 --cores 8
