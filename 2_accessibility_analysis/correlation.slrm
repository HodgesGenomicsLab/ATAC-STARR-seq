#!/bin/bash
#SBATCH --mail-user=tyler.j.hansen@vanderbilt.edu
#SBATCH --mail-type=ALL
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=4
#SBATCH --time=12:00:00
#SBATCH --mem=16G
#SBATCH --output=bam_reproducibility-%j.out
##################
#Tyler Hansen 4.22.2021
#This is a slurm script to determine reproduciblity via correlation plots using deeptools and bam files as input. 
##################

#Software
module restore tools

#Define path variables.
AS_DIR='/data/hodges_lab/ATAC-STARR_V2/data'
BUEN_DIR='/data/hodges_lab/public_data/GM12878/obtained_as_raw_files/ATAC_GM12878_2013-buenrostro/data'
RESULTS_DIR='/data/hodges_lab/ATAC-STARR_V2/results/accessibility/reproducibility'

#Concatenate peak files and merge. This will be the regions used in the correlation plots. 
cat ${AS_DIR}/accessibility/genrich_ATAC-like_peaks/GM12878inGM12878_DNA_genrich_0.0001-qvalue.narrowPeak \
    ${BUEN_DIR}/genrich_peaks/GM12878_ATAC-seq_buenrostro_genrich_0.0001-qvalue.narrowPeak |
    bedtools merge -i - > ${RESULTS_DIR}/ATAC-STARR+Buenrostro_consensus-peaks.bed

#Software
module restore anaconda
source activate deep_tools_v1

#Only on merged bams. Could do indivudual reps if needed later. 
multiBamSummary BED-file --BED ${RESULTS_DIR}/ATAC-STARR+Buenrostro_consensus-peaks.bed --bamfiles ${AS_DIR}/bams/pos-sorted/GM12878inGM12878_DNA_merged.unique.pos-sorted.bam \
    ${BUEN_DIR}/bams/pos-sorted/GM12878_ATAC-seq_buenrostro_merged.unique.pos-sorted.bam \
    -o ${RESULTS_DIR}/ATAC-STARR+Buenrostro_reproducibility_merged-bams.npz -l ATAC-STARR Buenrostro -p 4 -e --outRawCounts ${RESULTS_DIR}/ATAC-STARR+Buenrostro_reproducibility_merged-bams.tsv 

#Plot Correlation #These plots were not used in the paper. I generated my own in R using the RawCounts output from above. 
plotCorrelation -in ${RESULTS_DIR}/ATAC-STARR+Buenrostro_reproducibility_merged-bams.npz -c pearson --skipZeros -p scatterplot \
    -o ${RESULTS_DIR}/ATAC-STARR+Buenrostro_reproducibility_merged-bams_scatterplot_pearson.pdf --log1p
plotCorrelation -in ${RESULTS_DIR}/ATAC-STARR+Buenrostro_reproducibility_merged-bams.npz -c spearman --skipZeros -p scatterplot \
    -o ${RESULTS_DIR}/ATAC-STARR+Buenrostro_reproducibility_merged-bams_scatterplot_spearman.pdf --log1p 
