---
title: "Calling Active and Silent Regulatory Elements from ATAC-STARR Data using the 'bin method'"
author: "Tyler Hansen"
date: "April 23rd, 2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

This is an r markdown script that details the analysis and results of the ATAC-STARR V2 dataset. Briefly, active regions are called using DESeq2 which performs differential analysis on the counts matrix that is fed in. The active must have a padj (Benjamin-Hochberg corrected p-value) < 0.1 and a Log2(RNA/DNA "foldchange") > 0. I also extract silent regions, padj < 0.1, L2FC < 0. I then isolate these regions, add positional information using the cts file, and write as a tsv for downstream analysis. 

In addition, I use the dds object to give me a normalized counts matrix, which I use to calculate reproducibility and correlation for the replicates.

R version 3.6.1 | 16GB RAM

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, Load Libraries, message=FALSE, warning=FALSE}
#Load required libraries
library(DESeq2)
library(tidyverse)
library(hexbin)
library(extrafont)
loadfonts(device = "win")
library(apeglm)
library(eulerr)
```

```{r, Call Peaks - with Dups}
#Read in counts matrix
cts_df <- read_tsv('C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/cts_matricies/bin-method/GM12878inGM12878_counts_bin-method_50bp-bins_with-duplicates.tsv', 
                col_names = c("Bin_ID", "Chr", "Start", "End", "Strand", "Length", "DNA1", "DNA2", "RNA1", "RNA2"), col_types = "cciiciiiii", skip = 2)

#Convert cts to a matrix of integer counts with row names represented by Peak_ID.
cts_matrix <- as.matrix(dplyr::select(cts_df, Bin_ID, DNA1, DNA2, RNA1, RNA2) %>% column_to_rownames(var = "Bin_ID"))

# Prepare dataframe of sample info
condition <- c("DNA", "DNA", "RNA", "RNA")
RNames <- c("DNA1", "DNA2", "RNA1", "RNA2")
coldata <- data.frame(row.names = RNames, condition)

#Check that coldata matches cts. 
all(rownames(coldata) == colnames(cts_matrix))

#Set up experimental design for DEseq2
dds <- DESeqDataSetFromMatrix(countData = cts_matrix, colData = coldata, design = ~ condition)

#differential expression analysis. Use local. I tried all three, mean has a poor fit and parametric defaults to local anyway. 
dds <- DESeq(dds, fitType="local")

#Extract results: RNA/DNA
res <- lfcShrink(dds, coef="condition_RNA_vs_DNA", type="apeglm") 

#Convert to df and add Bin_ID column from rownames. 
res_df <- as.data.frame(res) %>% rownames_to_column(var = "Bin_ID")

#Obtain active peaks using the following filters: padj < 0.1 and l2fc > 0. 
active <- filter(res_df, padj < 0.1) %>% filter(log2FoldChange > 0) 

#Add positional information back by joining with cts_df. Then format to bed (log2Fc as score) and sort by position.  
active_bed <- left_join(active, cts_df, by = c("Bin_ID" = "Bin_ID"), keep = FALSE) %>% 
           dplyr::select(Chr, Start, End, Bin_ID, log2FoldChange, Strand) %>% 
           dplyr::arrange(Chr, Start, End)

#Obtain silent peaks using the following filters: padj < 0.1 and l2fc < 0. 
silent <- filter(res_df, padj < 0.1) %>% filter(log2FoldChange < 0) 

#Add positional information back by joining with cts_df. Then format to bed (log2Fc as score) and sort by position.  
silent_bed <- left_join(silent, cts_df, by = c("Bin_ID" = "Bin_ID"), keep = FALSE) %>% 
           dplyr::select(Chr, Start, End, Bin_ID, log2FoldChange, Strand) %>% 
           dplyr::arrange(Chr, Start, End)

#Save active and silent bed files. 
setwd("C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/")
write_tsv(active_bed, "DESeq2_results/bin-method/GM12878inGM12878_active_0.1padj_50-bin.bed", col_names = FALSE)
write_tsv(silent_bed, "DESeq2_results/bin-method/GM12878inGM12878_silent_0.1padj_50-bin.bed", col_names = FALSE)

#export troubleshooting plots
tiff("C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/dispersion-plot.tiff", compression = "zip")
plotDispEsts(dds)
dev.off()

tiff("C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/MA-plot.tiff", compression = "zip")
plotMA(res)
dev.off()

### Volcano Plot ###
#Volcano plot
volcano <- ggplot(res_df) +
  geom_bin2d(aes(x=log2FoldChange, y=-log10(padj)), bins = 500) +
  scale_fill_viridis_c(trans = "log", breaks = c(0, 20, 400, 8000, 160000), option = "magma") +
  geom_hline(yintercept = c(-log10(0.1)), linetype = "dashed") +
  geom_vline(xintercept = c(0), linetype = "dashed") +
  xlab(bquote(~log[2]~"fold-change (RNA/DNA)")) +
  ylab(bquote("-"~log[10]~"BH-adjusted p-value")) +
  theme_minimal(base_size = 8, base_family = "Arial") +
  theme(legend.position = "right", legend.key.height = unit(0.25, units = "in"), legend.key.width = unit(0.1, units = "in"), axis.title = element_text(face = "bold")) +
  coord_cartesian(xlim = c(-5,5), ylim = c(0,100))

#Save as pdf and tiff
ggsave("C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GM12878inGM12878_volcano.pdf", plot = volcano, width=4, height=3, device = cairo_pdf)

#Pie Chart
plotPie <- function(dfTable){
  ggplot(dfTable, aes(x = "", y = value, fill = Group)) + # We will change coordinates to polar two lines down. No x needed
    geom_bar(width = 1, stat = "identity", color = "white", size=0.25) + # Pie chart based off bar base 
    coord_polar("y", start = 0) +
    geom_text(aes(label = paste0(round(value / sum(value) * 100, 1), "%")), position = position_stack(vjust = 0.5), size = 4, family="Arial") + # Label w/ %'s
    scale_fill_manual(values=c("steelblue","firebrick","gray")) +
    theme_void(base_family = "Arial", base_size = 8) +
    theme(legend.title = element_blank())
}
#make df with groups and values to plot. 
df <- data.frame(
  Group = c("Active Bins\n(123,424)","Silent Bins\n(320,044)","Not Significant\n(4,097,490)"),
  value = c(123424,320044,4097490)
)

#make group factored and order for plotting. 
df$Group <- factor(df$Group, levels = c("Active Bins\n(123,424)","Silent Bins\n(320,044)","Not Significant\n(4,097,490)"))

#Execute function.
pie <-plotPie(df)

ggsave(pie, filename = "C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GM12878inGM12878_piechart.pdf", device = cairo_pdf, width=4, height=2.5)

### Calculate Reproducibility ###
#Compare counts per bin for both DNA and RNA individually, then compare ratios/actvity. 
#extract normalized counts from dds object. Convert to df, calculate log2FC for each rep. 
save(dds, file = "C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GM12878_dds.Rdata")
save(res, file = "C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GM12878_res.Rdata")
norm_cts <- counts(dds, normalized = TRUE) 
norm_cts_df <- as.data.frame(norm_cts) %>% rownames_to_column(var = "Bin_ID")

## RNA ##
#Plot correlation
RNA_plot <- ggplot(norm_cts_df, aes(x=RNA1, y=RNA2)) +
  geom_bin2d(bins = 300) +
  scale_fill_viridis_c(trans = "log", breaks = c(0, 20, 400, 8000, 160000)) +
  geom_abline(mapping=aes(slope=1, intercept=0), colour="black", linetype="dashed", size=0.25) + 
  theme_bw(base_family = "Arial", base_size = 6) + 
  xlab("Rep1 RNA count (per bin)") + 
  ylab("Rep2 RNA count (per bin)") +
  labs(fill = "Count") +
  theme(legend.position = "right", legend.key.height = unit(0.25, units = "in"), legend.key.width = unit(0.1, units = "in"), axis.title = element_text(face = "bold"))

#Save plot
ggsave(RNA_plot, filename ="C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GG_activity-correlation_RNA.pdf", device = cairo_pdf, units = "in", height = 2.5, width = 3)

#Calculate correlation:
cor.test(norm_cts_df$RNA1, norm_cts_df$RNA2, method = "spearman") # rho = 0.8359403 
cor.test(norm_cts_df$RNA1, norm_cts_df$RNA2, method = "pearson") # r2 = 0.9670015

## DNA ##
#Plot correlation
DNA_plot <- ggplot(norm_cts_df, aes(x=DNA1, y=DNA2)) +
  geom_bin2d(bins = 300) +
  scale_fill_viridis_c(trans = "log", breaks = c(0, 20, 400, 8000, 160000)) +
  geom_abline(mapping=aes(slope=1, intercept=0), colour="black", linetype="dashed", size=0.25) + 
  theme_bw(base_family = "Arial", base_size = 6) + 
  xlab("Rep1 DNA count (per bin)") + 
  ylab("Rep2 DNA count (per bin)") +
  labs(fill = "Count") +
  theme(legend.position = "right", legend.key.height = unit(0.25, units = "in"), legend.key.width = unit(0.1, units = "in"), axis.title = element_text(face = "bold"))

#Save plot
ggsave(DNA_plot, filename ="C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GG_activity-correlation_DNA.pdf", device = cairo_pdf, units = "in", height = 2.5, width = 3)

#Calculate correlation:
cor.test(norm_cts_df$DNA1, norm_cts_df$DNA2, method = "spearman") # rho = 0.9504847 
cor.test(norm_cts_df$DNA1, norm_cts_df$DNA2, method = "pearson") # r2 = 0.9942338 

## RNA/DNA ##
#Calculate ratio and remove infinite values
norm_cts_df_ratio <- mutate(norm_cts_df, rep1=log2(RNA1/DNA1), rep2=log2(RNA2/DNA2)) %>% filter(rep1!="-Inf", rep2!="-Inf", rep1!="Inf", rep2!="Inf", rep1!="NaN", rep2!="NaN")

#Plot correlation
ratio_plot <- ggplot(norm_cts_df_ratio, aes(x=rep1, y=rep2)) +
  geom_bin2d(bins = 300) +
  scale_fill_viridis_c(trans = "log", breaks = c(0, 10, 100, 1000)) +
  geom_abline(mapping=aes(slope=1, intercept=0), colour="black", linetype="dashed", size=0.25) + 
  theme_bw(base_family = "Arial", base_size = 6) + 
  xlab("Rep1 RNA/DNA ratio (per bin)") + 
  ylab("Rep2 RNA/DNA ratio (per bin)") +
  labs(fill = "Count") +
  theme(legend.position = "right", legend.key.height = unit(0.25, units = "in"), legend.key.width = unit(0.1, units = "in"), axis.title = element_text(face = "bold")) +
  coord_cartesian(xlim = c(-10,10), ylim = c(-10,10))

#Save plot
ggsave(ratio_plot, filename ="C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GG_activity-correlation_ratio.pdf", device = cairo_pdf, units = "in", height = 2.5, width = 3)

#Calculate correlation:
cor.test(norm_cts_df_ratio$rep1, norm_cts_df_ratio$rep2, method = "spearman") # rho = 0.2819462  
cor.test(norm_cts_df_ratio$rep1, norm_cts_df_ratio$rep2, method = "pearson") # r2 = 0.337751

```

```{r, Call Peaks - without Dups}
#Read in counts matrix
cts_df <- read_tsv('C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/cts_matricies/bin-method/GM12878inGM12878_counts_bin-method_50bp-bins_no-duplicates.tsv', 
                col_names = c("Bin_ID", "Chr", "Start", "End", "Strand", "Length", "DNA1", "DNA2", "RNA1", "RNA2"), col_types = "cciiciiiii", skip = 2)

#Convert cts to a matrix of integer counts with row names represented by Peak_ID.
cts_matrix <- as.matrix(dplyr::select(cts_df, Bin_ID, DNA1, DNA2, RNA1, RNA2) %>% column_to_rownames(var = "Bin_ID"))

# Prepare dataframe of sample info
condition <- c("DNA", "DNA", "RNA", "RNA")
RNames <- c("DNA1", "DNA2", "RNA1", "RNA2")
coldata <- data.frame(row.names = RNames, condition)

#Check that coldata matches cts. 
all(rownames(coldata) == colnames(cts_matrix))

#Set up experimental design for DEseq2
dds <- DESeqDataSetFromMatrix(countData = cts_matrix, colData = coldata, design = ~ condition)

#differential expression analysis. Use local. I tried all three, mean has a poor fit and parametric defaults to local anyway. 
dds <- DESeq(dds, fitType="local")

#Extract results: RNA/DNA
res <- lfcShrink(dds, coef="condition_RNA_vs_DNA", type="apeglm") 

#Convert to df and add Bin_ID column from rownames. 
res_df <- as.data.frame(res) %>% rownames_to_column(var = "Bin_ID")

#Obtain active peaks using the following filters: padj < 0.1 and l2fc > 0. 
active <- filter(res_df, padj < 0.1) %>% filter(log2FoldChange > 0) 

#Add positional information back by joining with cts_df. Then format to bed (log2Fc as score) and sort by position.  
active_bed <- left_join(active, cts_df, by = c("Bin_ID" = "Bin_ID"), keep = FALSE) %>% 
           dplyr::select(Chr, Start, End, Bin_ID, log2FoldChange, Strand) %>% 
           dplyr::arrange(Chr, Start, End)

#Obtain silent peaks using the following filters: padj < 0.1 and l2fc < 0. 
silent <- filter(res_df, padj < 0.1) %>% filter(log2FoldChange < 0) 

#Add positional information back by joining with cts_df. Then format to bed (log2Fc as score) and sort by position.  
silent_bed <- left_join(silent, cts_df, by = c("Bin_ID" = "Bin_ID"), keep = FALSE) %>% 
           dplyr::select(Chr, Start, End, Bin_ID, log2FoldChange, Strand) %>% 
           dplyr::arrange(Chr, Start, End)

#Save active and silent bed files. 
setwd("C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/")
write_tsv(active_bed, "DESeq2_results/bin-method/GM12878inGM12878_active_0.1padj_50-bin_no-duplicates.bed", col_names = FALSE)
write_tsv(silent_bed, "DESeq2_results/bin-method/GM12878inGM12878_silent_0.1padj_50-bin_no-duplicates.bed", col_names = FALSE)

#export troubleshooting plots
tiff("C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/dispersion-plot_no-dups.tiff", compression = "zip")
plotDispEsts(dds)
dev.off()

tiff("C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/MA-plot_no-dups.tiff", compression = "zip")
plotMA(res)
dev.off()

### Volcano Plot ###
#Volcano plot
volcano <- ggplot(res_df) +
  geom_bin2d(aes(x=log2FoldChange, y=-log10(padj)), bins = 500) +
  scale_fill_viridis_c(trans = "log", breaks = c(0, 20, 400, 8000, 160000), option = "magma") +
  geom_hline(yintercept = c(-log10(0.1)), linetype = "dashed") +
  geom_vline(xintercept = c(0), linetype = "dashed") +
  xlab(bquote(~log[2]~"fold-change (RNA/DNA)")) +
  ylab(bquote("-"~log[10]~"BH-adjusted p-value")) +
  theme_minimal(base_size = 8, base_family = "Arial") +
  theme(legend.position = "right", legend.key.height = unit(0.25, units = "in"), legend.key.width = unit(0.1, units = "in"), axis.title = element_text(face = "bold")) +
  coord_cartesian(xlim = c(-3,3), ylim = c(0,50))

#Save as pdf
ggsave("C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GM12878inGM12878_volcano_no-dup.pdf", plot = volcano, width=4, height=3, device = cairo_pdf)

#Pie Chart
plotPie <- function(dfTable){
  ggplot(dfTable, aes(x = "", y = value, fill = Group)) + # We will change coordinates to polar two lines down. No x needed
    geom_bar(width = 1, stat = "identity", color = "white", size=0.25) + # Pie chart based off bar base 
    coord_polar("y", start = 0) +
    geom_text(aes(label = paste0(round(value / sum(value) * 100, 1), "%")), position = position_stack(vjust = 0.5), size = 4, family="Arial") + # Label w/ %'s
    scale_fill_manual(values=c("steelblue","firebrick","gray")) +
    theme_void(base_family = "Arial", base_size = 8) +
    theme(legend.title = element_blank())
}
#make df with groups and values to plot. 
df <- data.frame(
  Group = c("Active Bins\n(38,534)","Silent Bins\n(276,830)","Not Significant\n(4,225,594)"),
  value = c(38534,276830,4225594)
)

#make group factored and order for plotting. 
df$Group <- factor(df$Group, levels = c("Active Bins\n(38,534)","Silent Bins\n(276,830)","Not Significant\n(4,225,594)"))

#Execute function.
pie <-plotPie(df)

ggsave(pie, filename = "C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GM12878inGM12878_piechart_no-dup.pdf", device = cairo_pdf, width=4, height=2.5)

### Calculate Reproducibility ###
#Compare counts per bin for both DNA and RNA individually, then compare ratios/actvity. 
#extract normalized counts from dds object. Convert to df, calculate log2FC for each rep. 
save(dds, file = "C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GM12878-noDup_dds.Rdata")
save(res, file = "C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GM12878-noDup_res.Rdata")
norm_cts <- counts(dds, normalized = TRUE) 
norm_cts_df <- as.data.frame(norm_cts) %>% rownames_to_column(var = "Bin_ID")

## RNA ##
#Plot correlation
RNA_plot <- ggplot(norm_cts_df, aes(x=RNA1, y=RNA2)) +
  geom_bin2d(bins = 300) +
  scale_fill_viridis_c(trans = "log", breaks = c(0, 20, 400, 8000, 160000)) +
  geom_abline(mapping=aes(slope=1, intercept=0), colour="black", linetype="dashed", size=0.25) + 
  theme_bw(base_family = "Arial", base_size = 6) + 
  xlab("Rep1 RNA count (per bin)") + 
  ylab("Rep2 RNA count (per bin)") +
  labs(fill = "Count") +
  theme(legend.position = "right", legend.key.height = unit(0.25, units = "in"), legend.key.width = unit(0.1, units = "in"), axis.title = element_text(face = "bold"))

#Save plot
ggsave(RNA_plot, filename ="C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GG_activity-correlation_RNA_no-dup.pdf", device = cairo_pdf, units = "in", height = 2.5, width = 3)

#Calculate correlation:
cor.test(norm_cts_df$RNA1, norm_cts_df$RNA2, method = "spearman") # rho = 0.9059168 
cor.test(norm_cts_df$RNA1, norm_cts_df$RNA2, method = "pearson") # r2 = 0.9850145

## DNA ##
#Plot correlation
DNA_plot <- ggplot(norm_cts_df, aes(x=DNA1, y=DNA2)) +
  geom_bin2d(bins = 300) +
  scale_fill_viridis_c(trans = "log", breaks = c(0, 20, 400, 8000, 160000)) +
  geom_abline(mapping=aes(slope=1, intercept=0), colour="black", linetype="dashed", size=0.25) + 
  theme_bw(base_family = "Arial", base_size = 6) + 
  xlab("Rep1 DNA count (per bin)") + 
  ylab("Rep2 DNA count (per bin)") +
  labs(fill = "Count") +
  theme(legend.position = "right", legend.key.height = unit(0.25, units = "in"), legend.key.width = unit(0.1, units = "in"), axis.title = element_text(face = "bold"))

#Save plot
ggsave(DNA_plot, filename ="C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GG_activity-correlation_DNA_no-dup.pdf", device = cairo_pdf, units = "in", height = 2.5, width = 3)

#Calculate correlation:
cor.test(norm_cts_df$DNA1, norm_cts_df$DNA2, method = "spearman") # rho = 0.9560129
cor.test(norm_cts_df$DNA1, norm_cts_df$DNA2, method = "pearson") # r2 = 0.9943792  

## RNA/DNA ##
#Calculate ratio and remove infinite values
norm_cts_df_ratio <- mutate(norm_cts_df, rep1=log2(RNA1/DNA1), rep2=log2(RNA2/DNA2)) %>% filter(rep1!="-Inf", rep2!="-Inf", rep1!="Inf", rep2!="Inf", rep1!="NaN", rep2!="NaN")

#Plot correlation
ratio_plot <- ggplot(norm_cts_df_ratio, aes(x=rep1, y=rep2)) +
  geom_bin2d(bins = 300) +
  scale_fill_viridis_c(trans = "log", breaks = c(0, 10, 100, 1000)) +
  geom_abline(mapping=aes(slope=1, intercept=0), colour="black", linetype="dashed", size=0.25) + 
  theme_bw(base_family = "Arial", base_size = 6) + 
  xlab("Rep1 RNA/DNA ratio (per bin)") + 
  ylab("Rep2 RNA/DNA ratio (per bin)") +
  labs(fill = "Count") +
  theme(legend.position = "right", legend.key.height = unit(0.25, units = "in"), legend.key.width = unit(0.1, units = "in"), axis.title = element_text(face = "bold")) +
  coord_cartesian(xlim = c(-10,10), ylim = c(-10,10))

#Save plot
ggsave(ratio_plot, filename ="C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/data/activity/individual/DESeq2_results/bin-method/GG_activity-correlation_ratio_no-dup.pdf", device = cairo_pdf, units = "in", height = 2.5, width = 3)

#Calculate correlation:
cor.test(norm_cts_df_ratio$rep1, norm_cts_df_ratio$rep2, method = "spearman") # rho = 0.3780574  
cor.test(norm_cts_df_ratio$rep1, norm_cts_df_ratio$rep2, method = "pearson") # r2 = 0.474768 

```

```{r, Compare +/- duplicates overlap}
#### View Region Overlap as a Venn Diagram ####
#These numbers are from doing a bedtools jaccard on accre:
#Make a vector of the values above:
combo <- c(`Duplicates Included\n(14,617)` = 14617-3071, `Duplicates Removed\n(3,855)` = 3855-3071, "Duplicates Included\n(14,617)&Duplicates Removed\n(3,855)" = 3071)
eul <- plot(euler(combo), quantities = TRUE) 

ggsave(eul, filename = "C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/results/activity/withDups-vs-withoutDups/euler-plot.pdf", device = cairo_pdf, width = 5, height = 3)
```

```{r}
df <- data.frame(Group = c("Active Regions","Silent Regions"),
  value = c(14617, 19393))

bar <- ggplot(df, aes(x=Group, y=value, fill = Group)) +
  geom_col() +
  theme_bw(base_family = "Arial", base_size = 6) + 
  ylab("Number of Regions") +
  scale_fill_manual(values=c("steelblue","firebrick"))+
  theme(legend.position = "none", axis.title.x = element_blank())

ggsave(plot = bar, filename = "C:/Users/tyler/Dropbox (VU Basic Sciences)/Hodges Lab/Results and Data/Bioinformatics/ATAC-STARR_analysis/3_Accre_Local/ATAC-STARR/results/activity/ATAC-STARR_RE_analysis/region_number_bar.pdf", device = cairo_pdf, width = 2, height = 2)
```

