#!/bin/bash
#SBATCH --mail-user=tyler.j.hansen@vanderbilt.edu
#SBATCH --mail-type=ALL
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=12
#SBATCH --time=24:00:00
#SBATCH --mem=32G
#SBATCH --reservation=AtRiskUnstableEnvironment
#######################################################
# Tyler Hansen 6.1.2021

#Paths
FOOT_DIR='/data/hodges_lab/ATAC-STARR_V2/data/accessibility/footprinting/ATACorrect'
TFBS_DIR='/data/hodges_lab/ATAC-STARR_V2/data/accessibility/footprinting/BINDetect/GM12878inGM12878'
RE_DIR='/data/hodges_lab/ATAC-STARR_V2/data/activity/individual/DESeq2_results/bin-method/'
OUT_DIR='/data/hodges_lab/ATAC-STARR_V2/results/multiomic/Cluster'

#Convert beigwig to bedgraph. 
#bigWigToBedGraph ${FOOT_DIR}/GM12878inGM12878_DNA_corrected.bw ${FOOT_DIR}/GM12878inGM12878_DNA_corrected.bedGraph

#Intersect bedgraph with bound TFBS and convert to bigwig. The TFs chosen here were handpicked based on the HOMER results and knowledge of known B cell regulators.  
#module restore tools 
#for TF in IRF8_MA0652.1 ELK1_MA0028.2 YY1_MA0095.2 NFKB1_MA0105.4 JUNB_MA0490.2 \
#THAP11_MA1573.1 SPIB_MA0081.2 TP53_MA0106.3 TP73_MA0861.1 BACH2_MA1101.2 EBF1_MA0154.4 TCF3_MA0522.3 PAX5_MA0014.3 \
#CTCF_MA0139.1 SP1_MA0079.4 KLF3_MA1516.1 NFYA_MA0060.3 Foxo1_MA0480.1 SPI1_MA0080.5 BCL6_MA0463.2 IKZF1_MA1508.1 PRDM1_MA0508.3 XBP1_MA0844.1 \
#ZBTB7A_MA0750.2 ZBTB32_MA1580.1
#do 
#    bedtools intersect -u -a ${FOOT_DIR}/GM12878inGM12878_DNA_corrected.bedGraph -b ${TFBS_DIR}/${TF}/beds/${TF}_GM12878inGM12878_DNA_bound.bed > ${OUT_DIR}/${TF}_GM12878inGM12878_DNA_corrected.bedGraph 
#    bedGraphToBigWig ${OUT_DIR}/${TF}_GM12878inGM12878_DNA_corrected.bedGraph /home/hansetj1/chrom.sizes/hg38.chrom.sizes ${OUT_DIR}/${TF}_GM12878inGM12878_DNA_corrected.bw
#done

#Make heatmap using multibigwig summary for Active and silent regions. 
module restore anaconda
source activate deep_tools_v1
multiBigwigSummary BED-file -b ${OUT_DIR}/IRF8_MA0652.1_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/ELK1_MA0028.2_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/YY1_MA0095.2_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/NFKB1_MA0105.4_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/JUNB_MA0490.2_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/THAP11_MA1573.1_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/SPIB_MA0081.2_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/TP53_MA0106.3_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/TP73_MA0861.1_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/BACH2_MA1101.2_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/EBF1_MA0154.4_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/TCF3_MA0522.3_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/PAX5_MA0014.3_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/CTCF_MA0139.1_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/SP1_MA0079.4_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/KLF3_MA1516.1_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/NFYA_MA0060.3_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/Foxo1_MA0480.1_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/SPI1_MA0080.5_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/BCL6_MA0463.2_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/IKZF1_MA1508.1_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/PRDM1_MA0508.3_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/XBP1_MA0844.1_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/ZBTB7A_MA0750.2_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/ZBTB32_MA1580.1_GM12878inGM12878_DNA_corrected.bw \
    --BED ${RE_DIR}/GM12878inGM12878_active_0.1padj_50-bin.merged.bed \
    --labels IRF8 ELK1 YY1 NFKB1 JUNB THAP11 SPIB TP53 TP73 BACH2 EBF1 TCF3 PAX5 CTCF SP1 KLF3 NFYA Foxo1 SPI1 BCL6 IKZF1 PRDM1 XBP1 ZBTB7A ZBTB32 \
    -o ${OUT_DIR}/TF-binding-scores_active.npz --outRawCounts ${OUT_DIR}/TF-binding-scores_active_rawCounts.tsv -p 12

multiBigwigSummary BED-file -b ${OUT_DIR}/IRF8_MA0652.1_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/ELK1_MA0028.2_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/YY1_MA0095.2_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/NFKB1_MA0105.4_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/JUNB_MA0490.2_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/THAP11_MA1573.1_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/SPIB_MA0081.2_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/TP53_MA0106.3_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/TP73_MA0861.1_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/BACH2_MA1101.2_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/EBF1_MA0154.4_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/TCF3_MA0522.3_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/PAX5_MA0014.3_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/CTCF_MA0139.1_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/SP1_MA0079.4_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/KLF3_MA1516.1_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/NFYA_MA0060.3_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/Foxo1_MA0480.1_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/SPI1_MA0080.5_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/BCL6_MA0463.2_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/IKZF1_MA1508.1_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/PRDM1_MA0508.3_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/XBP1_MA0844.1_GM12878inGM12878_DNA_corrected.bw \
    ${OUT_DIR}/ZBTB7A_MA0750.2_GM12878inGM12878_DNA_corrected.bw ${OUT_DIR}/ZBTB32_MA1580.1_GM12878inGM12878_DNA_corrected.bw \
    --BED ${RE_DIR}/GM12878inGM12878_silent_0.1padj_50-bin.merged.bed \
    --labels IRF8 ELK1 YY1 NFKB1 JUNB THAP11 SPIB TP53 TP73 BACH2 EBF1 TCF3 PAX5 CTCF SP1 KLF3 NFYA Foxo1 SPI1 BCL6 IKZF1 PRDM1 XBP1 ZBTB7A ZBTB32 \
    -o ${OUT_DIR}/TF-binding-scores_silent.npz --outRawCounts ${OUT_DIR}/TF-binding-scores_silent_rawCounts.tsv -p 12
